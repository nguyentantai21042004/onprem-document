pipeline {
    agent {
        label 'smap-app'
    }
    
    stages {
        stage('ğŸ” Jenkins Agent Info') {
            steps {
                echo "ğŸ” Checking Jenkins Agent basic info..."
                sh '''
                    echo "=== Jenkins Agent User ==="
                    whoami
                    id
                    
                    echo "=== System Info ==="
                    hostname
                    uname -a
                    
                    echo "=== Current Directory ==="
                    pwd
                    ls -la
                    
                    echo "=== Home Directory ==="
                    echo "HOME: $HOME"
                    ls -la $HOME || echo "Cannot access home directory"
                '''
            }
        }
        
        stage('ğŸ³ Docker Permission Check') {
            steps {
                echo "ğŸ³ Testing Docker permissions..."
                script {
                    try {
                        sh '''
                            echo "=== Docker Version ==="
                            docker --version
                            
                            echo "=== Docker Info ==="
                            docker info | head -10
                            
                            echo "=== Docker Permission Test ==="
                            docker ps
                            
                            echo "=== Docker Images ==="
                            docker images | head -5
                            
                            echo "âœ… Docker permissions: OK"
                        '''
                    } catch (Exception e) {
                        echo "âŒ Docker permission issue!"
                        sh '''
                            echo "=== Groups check ==="
                            groups
                            
                            echo "=== Docker group members ==="
                            grep docker /etc/group || echo "Docker group not found"
                            
                            echo "=== Docker service status ==="
                            systemctl status docker || service docker status || echo "Cannot check docker service"
                            
                            echo "=== Docker socket permissions ==="
                            ls -la /var/run/docker.sock
                        '''
                        error("Docker permissions failed!")
                    }
                }
            }
        }
        
        stage('ğŸ“ Directory Permissions') {
            steps {
                echo "ğŸ“ Checking required directories..."
                sh '''
                    echo "=== /source directory check ==="
                    if [ -d "/source" ]; then
                        echo "âœ… /source exists"
                        ls -la /source/
                        
                        echo "=== Write permission test ==="
                        if touch /source/test-jenkins-write 2>/dev/null; then
                            echo "âœ… Write permission: OK"
                            rm -f /source/test-jenkins-write
                        else
                            echo "âŒ Write permission: FAILED"
                            echo "Directory owner:"
                            ls -ld /source/
                        fi
                    else
                        echo "âŒ /source directory does not exist"
                        echo "Creating /source directory..."
                        sudo mkdir -p /source || mkdir -p /source || echo "Cannot create /source"
                    fi
                    
                    echo "=== /var/lib/jenkins directory check ==="
                    if [ -d "/var/lib/jenkins" ]; then
                        echo "âœ… /var/lib/jenkins exists"
                        ls -la /var/lib/jenkins/ | head -5
                        
                        echo "=== Write permission test ==="
                        if touch /var/lib/jenkins/test-jenkins-write 2>/dev/null; then
                            echo "âœ… Write permission: OK"
                            rm -f /var/lib/jenkins/test-jenkins-write
                        else
                            echo "âŒ Write permission: FAILED"
                            echo "Directory owner:"
                            ls -ld /var/lib/jenkins/
                        fi
                    else
                        echo "âŒ /var/lib/jenkins does not exist"
                    fi
                    
                    echo "=== Workspace directory ==="
                    pwd
                    ls -la
                '''
            }
        }
        
        stage('ğŸŒ Network Connectivity') {
            steps {
                echo "ğŸŒ Testing network connectivity..."
                sh '''
                    echo "=== Internet connectivity ==="
                    if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
                        echo "âœ… Internet: OK"
                    else
                        echo "âŒ Internet: FAILED"
                    fi
                    
                    echo "=== DNS resolution ==="
                    if nslookup google.com >/dev/null 2>&1; then
                        echo "âœ… DNS: OK"
                    else
                        echo "âŒ DNS: FAILED"
                    fi
                    
                    echo "=== Git connectivity test ==="
                    if curl -s --connect-timeout 5 https://github.com >/dev/null; then
                        echo "âœ… GitHub: OK"
                    else
                        echo "âŒ GitHub: FAILED"
                    fi
                    
                    if curl -s --connect-timeout 5 https://gitlab.com >/dev/null; then
                        echo "âœ… GitLab: OK"
                    else
                        echo "âŒ GitLab: FAILED"
                    fi
                    
                    echo "=== Jenkins Master connectivity ==="
                    if curl -s --connect-timeout 5 http://192.168.1.150:8080 >/dev/null; then
                        echo "âœ… Jenkins Master: OK"
                    else
                        echo "âŒ Jenkins Master: FAILED"
                    fi
                '''
            }
        }
        
        stage('ğŸ”§ Required Tools') {
            steps {
                echo "ğŸ”§ Checking required tools..."
                sh '''
                    echo "=== Git ==="
                    if command -v git >/dev/null 2>&1; then
                        echo "âœ… Git installed:"
                        git --version
                    else
                        echo "âŒ Git not found"
                    fi
                    
                    echo "=== Curl ==="
                    if command -v curl >/dev/null 2>&1; then
                        echo "âœ… Curl installed:"
                        curl --version | head -1
                    else
                        echo "âŒ Curl not found"
                    fi
                    
                    echo "=== Go (optional, for local builds) ==="
                    if command -v go >/dev/null 2>&1; then
                        echo "âœ… Go installed:"
                        go version
                    else
                        echo "âš ï¸ Go not found (OK if using Docker build)"
                    fi
                    
                    echo "=== Make (optional) ==="
                    if command -v make >/dev/null 2>&1; then
                        echo "âœ… Make installed:"
                        make --version | head -1
                    else
                        echo "âš ï¸ Make not found"
                    fi
                    
                    echo "=== Java ==="
                    if command -v java >/dev/null 2>&1; then
                        echo "âœ… Java installed:"
                        java -version 2>&1 | head -1
                    else
                        echo "âŒ Java not found"
                    fi
                '''
            }
        }
        
        stage('ğŸ‹ Harbor Registry Test') {
            steps {
                echo "ğŸ‹ Testing Harbor registry connectivity and login..."
                script {
                    def harborUrl = "registry.ngtantai.pro"
                    
                    sh """
                        echo "=== Harbor connectivity test ==="
                        HARBOR_URL="${harborUrl}"
                        
                        echo "Testing Harbor at: \$HARBOR_URL"
                        
                        echo "=== Basic connectivity ==="
                        if curl -s --connect-timeout 10 -I https://\$HARBOR_URL >/dev/null 2>&1; then
                            echo "âœ… Harbor HTTPS: OK"
                        else
                            echo "âš ï¸ Harbor HTTPS: FAILED, trying HTTP"
                            if curl -s --connect-timeout 10 -I http://\$HARBOR_URL >/dev/null 2>&1; then
                                echo "âœ… Harbor HTTP: OK"
                            else
                                echo "âŒ Harbor: FAILED"
                            fi
                        fi
                        
                        echo "=== Harbor UI accessibility ==="
                        if curl -s --connect-timeout 10 "https://\$HARBOR_URL" | grep -i harbor >/dev/null 2>&1; then
                            echo "âœ… Harbor UI: Accessible"
                        else
                            echo "âš ï¸ Harbor UI: May not be accessible"
                        fi
                    """
                    
                    // Test Harbor login náº¿u credentials Ä‘Ã£ Ä‘Æ°á»£c setup
                    echo "=== Harbor Authentication Test ==="
                    try {
                        withCredentials([usernamePassword(credentialsId: 'harbor-credentials', 
                                                        usernameVariable: 'HARBOR_USER', 
                                                        passwordVariable: 'HARBOR_PASS')]) {
                            sh """
                                echo "Testing Harbor login with stored credentials..."
                                HARBOR_URL="${harborUrl}"
                                
                                if echo \$HARBOR_PASS | docker login \$HARBOR_URL -u \$HARBOR_USER --password-stdin; then
                                    echo "âœ… Harbor Login: SUCCESS"
                                    
                                    # Test push capability (vá»›i dummy tag)
                                    echo "Testing push capability..."
                                    if docker pull hello-world:latest; then
                                        docker tag hello-world:latest \$HARBOR_URL/library/test-jenkins:latest
                                        if docker push \$HARBOR_URL/library/test-jenkins:latest; then
                                            echo "âœ… Harbor Push: SUCCESS"
                                            # Cleanup
                                            docker rmi \$HARBOR_URL/library/test-jenkins:latest || true
                                        else
                                            echo "âŒ Harbor Push: FAILED (check project permissions)"
                                        fi
                                        docker rmi hello-world:latest || true
                                    else
                                        echo "âš ï¸ Cannot test push (hello-world not available)"
                                    fi
                                    
                                    # Logout
                                    docker logout \$HARBOR_URL
                                else
                                    echo "âŒ Harbor Login: FAILED"
                                fi
                            """
                        }
                    } catch (Exception e) {
                        echo "âš ï¸ Harbor credentials 'harbor-credentials' not found in Jenkins"
                        echo "   This is normal if you haven't set up Harbor credentials yet"
                        echo "   You'll need to add Harbor credentials before running the full pipeline"
                    }
                }
            }
        }
        
        stage('ğŸ’¾ Storage & Resources') {
            steps {
                echo "ğŸ’¾ Checking storage and resources..."
                sh '''
                    echo "=== Disk Space ==="
                    df -h | grep -E "(Filesystem|/dev/|/)"
                    
                    echo "=== Available Space for Docker ==="
                    docker system df || echo "Cannot get docker space info"
                    
                    echo "=== Memory ==="
                    free -h
                    
                    echo "=== CPU ==="
                    nproc
                    cat /proc/cpuinfo | grep "model name" | head -1
                    
                    echo "=== Load Average ==="
                    uptime
                    
                    echo "=== Docker system info ==="
                    docker system info 2>/dev/null | grep -E "(Total Memory|CPUs|Operating System)" || echo "Cannot get docker system info"
                '''
            }
        }
        
        stage('ğŸ” Jenkins Credentials Test') {
            steps {
                echo "ğŸ” Testing Jenkins credentials (if configured)..."
                script {
                    try {
                        sh '''
                            echo "=== Git configuration ==="
                            git config --global --list || echo "No global git config"
                            
                            echo "=== SSH keys ==="
                            ls -la ~/.ssh/ || echo "No SSH directory"
                            
                            echo "=== Environment variables ==="
                            env | grep -E "(JENKINS|JAVA|PATH)" | head -10
                        '''
                    } catch (Exception e) {
                        echo "âš ï¸ Some credential tests failed (normal if not configured yet)"
                    }
                }
            }
        }
        
        stage('ğŸ“‹ System Check Summary') {
            steps {
                echo "ğŸ“‹ Generating system check summary report..."
                sh '''
                    echo "=================================="
                    echo "ğŸ¯ SYSTEM CHECK SUMMARY REPORT"
                    echo "=================================="
                    echo "Agent: $(hostname)"
                    echo "User: $(whoami)"
                    echo "Date: $(date)"
                    echo ""
                    
                    echo "âœ… REQUIREMENTS CHECKLIST:"
                    echo "[ ] Jenkins Agent User: $(whoami)"
                    echo "[ ] Docker Access: $(docker ps >/dev/null 2>&1 && echo 'OK' || echo 'FAILED')"
                    echo "[ ] /var/lib/jenkins Directory: $([ -w /var/lib/jenkins ] && echo 'OK' || echo 'FAILED')"
                    echo "[ ] Internet Access: $(ping -c 1 8.8.8.8 >/dev/null 2>&1 && echo 'OK' || echo 'FAILED')"
                    echo "[ ] Git Tool: $(command -v git >/dev/null 2>&1 && echo 'OK' || echo 'FAILED')"
                    echo "[ ] Harbor Connectivity: Check logs above"
                    echo "[ ] Harbor Login: Check logs above"
                    echo ""
                    
                    echo "ğŸš€ SYSTEM STATUS:"
                    if docker ps >/dev/null 2>&1 && [ -w /var/lib/jenkins ] && ping -c 1 8.8.8.8 >/dev/null 2>&1; then
                        echo "âœ… SYSTEM READY FOR CI/CD"
                        echo "ğŸ‰ All basic requirements met!"
                    else
                        echo "âŒ SYSTEM NOT READY"
                        echo "ğŸ› ï¸ Please fix failed items above"
                    fi
                    
                    echo ""
                    echo "ğŸ”— USEFUL LINKS:"
                    echo "â€¢ Jenkins UI: http://192.168.1.150:8080/"
                    echo "â€¢ Harbor Registry: https://registry.ngtantai.pro/"
                    echo "â€¢ Agent Logs: sudo journalctl -u jenkins-agent -f"
                    echo ""
                    echo "=================================="
                '''
            }
        }
    }
    
    post {
        always {
            echo """
            ğŸ System check completed!
            
            ğŸ“Š Review the summary report above for any issues.
            ğŸ”§ Fix any FAILED items before proceeding with deployment pipeline.
            """
        }
        
        success {
            echo """
            âœ… All system checks passed! 
            
            ğŸš€ System is ready for CI/CD pipeline.
            ğŸ¯ You can now proceed with:
               â€¢ Setting up Harbor credentials
               â€¢ Creating production pipelines
               â€¢ Running application builds
            """
        }
        
        failure {
            echo """
            âŒ Some system checks failed! 
            
            ğŸ› ï¸ Common fixes:
            â€¢ sudo usermod -aG docker \$(whoami)
            â€¢ sudo mkdir -p /var/lib/jenkins && sudo chown \$(whoami):\$(whoami) /var/lib/jenkins
            â€¢ sudo systemctl start docker
            â€¢ sudo systemctl restart jenkins-agent
            
            ğŸ“ Contact DevOps team if you need assistance.
            """
        }
    }
}