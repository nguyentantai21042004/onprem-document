# /opt/monitoring/alertmanager/alertmanager.yml
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'discord-general'
  
  routes:
    # =============================================================================
    # VPN ALERTS - First priority, send immediately
    # =============================================================================
    - matchers:
        - vm_type="vpn"
        - severity="critical"
      receiver: 'discord-vpn-critical'
      group_wait: 5s
      repeat_interval: 15m
      continue: false

    - matchers:
        - vm_type="vpn"
        - severity="warning"
      receiver: 'discord-vpn-warning'
      group_wait: 30s
      repeat_interval: 1h
      continue: false

    # =============================================================================
    # GENERAL ALERTS
    # =============================================================================
    - matchers:
        - severity="critical"
      receiver: 'discord-critical'
      group_wait: 5s
      repeat_interval: 30m
      continue: false

    - matchers:
        - severity="warning"
      receiver: 'discord-warning'
      group_wait: 30s
      repeat_interval: 2h
      continue: false

receivers:
  # =============================================================================
  # VPN-SPECIFIC RECEIVERS - First priority
  # =============================================================================
  - name: 'discord-vpn-critical'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        title: 'üö® VPN CRITICAL - IMMEDIATE ACTION REQUIRED'
        text: |
          **üö® VPN INFRASTRUCTURE CRITICAL ALERT üö®**
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **üîç VPN Details:**
          ‚Ä¢ Instance: {{ .Labels.instance }}
          ‚Ä¢ VM Type: {{ .Labels.vm_type }}
          ‚Ä¢ Impact Level: {{ .Labels.impact }}
          ‚Ä¢ Started: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          **‚ö° CRITICAL: VPN services may be unavailable!**
          **üîß Action: Check VM status immediately**
          
          ---
          {{ end }}

  - name: 'discord-vpn-warning'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        title: '‚ö†Ô∏è VPN Warning Alert'
        text: |
          **‚ö†Ô∏è VPN Performance Warning**
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **VPN Details:**
          ‚Ä¢ Instance: {{ .Labels.instance }}
          ‚Ä¢ Impact: {{ .Labels.impact }}
          ‚Ä¢ Time: {{ .StartsAt.Format "15:04:05" }}
          
          üí° Monitor closely - may affect VPN performance
          
          ---
          {{ end }}

  # =============================================================================
  # GENERAL RECEIVERS
  # =============================================================================
  - name: 'discord-general'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        title: 'üìä Monitoring Alert'
        text: |
          **üìä HOMELAB MONITORING**
          
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Status:** {{ .Status }}
          **Instance:** {{ .Labels.instance }}
          **Time:** {{ .StartsAt.Format "15:04:05" }}
          
          ---
          {{ end }}

  - name: 'discord-critical'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        title: 'üö® CRITICAL ALERT'
        text: |
          **üö® CRITICAL SYSTEM ALERT üö®**
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **Details:**
          ‚Ä¢ Instance: {{ .Labels.instance }}
          ‚Ä¢ Started: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          **‚ö° Action Required: Immediate investigation needed!**
          
          ---
          {{ end }}

  - name: 'discord-warning'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        title: '‚ö†Ô∏è Warning Alert'
        text: |
          **‚ö†Ô∏è System Warning**
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **Instance:** {{ .Labels.instance }}
          **Time:** {{ .StartsAt.Format "15:04:05" }}
          
          ---
          {{ end }}

# =============================================================================
# INHIBIT RULES - Prevent alert spam
# =============================================================================
inhibit_rules:
  # If VPN VM is down, disable all other VPN VM alerts
  - source_matchers:
      - alertname="VPNNodeDown"
    target_matchers:
      - vm_type="vpn"
    equal: ['instance']

  # If there is a critical alert, disable warning alerts on the same instance
  - source_matchers:
      - severity="critical"
    target_matchers:
      - severity="warning"
    equal: ['instance']