# /opt/monitoring/alertmanager/alertmanager.yml
global:
  # Global SMTP configuration (for email alerts - optional)
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alertmanager@yourdomain.com'
  smtp_auth_username: ''
  smtp_auth_password: ''
  
  # Global webhook configurations
  http_config:
    proxy_url: ''
  
  # Resolve timeout
  resolve_timeout: 5m

# Templates for customizing notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route tree for alerts
route:
  # Default settings
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'discord-general'
  
  # Child routes with specific conditions
  routes:
    # Critical alerts - immediate notification
    - matchers:
        - severity="critical"
      receiver: 'discord-critical'
      group_wait: 5s
      group_interval: 30s
      repeat_interval: 30m
      continue: false

    # Warning alerts - less urgent
    - matchers:
        - severity="warning"
      receiver: 'discord-warnings'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 2h
      continue: false

    # Infrastructure alerts - separate channel
    - matchers:
        - category="infrastructure"
      receiver: 'discord-infrastructure'
      group_wait: 10s
      repeat_interval: 1h
      continue: false

# Notification receivers
receivers:
  # =============================================================================
  # DISCORD WEBHOOKS - Replace with your actual webhook URLs
  # =============================================================================
  
  - name: 'discord-general'
    webhook_configs:
      - url: 'YOUR_DISCORD_WEBHOOK_URL_HERE'
        send_resolved: true
        http_config:
          proxy_url: ''
        title: 'üìä Monitoring Alert - General'
        text: |
          **üìä HOMELAB MONITORING**
          
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Status:** {{ .Status }}
          **Severity:** {{ .Labels.severity }}
          **Instance:** {{ .Labels.instance }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          ---
          {{ end }}

  - name: 'discord-critical'
    webhook_configs:
      - url: 'YOUR_DISCORD_WEBHOOK_URL_HERE'
        send_resolved: true
        title: 'üö® CRITICAL ALERT - IMMEDIATE ACTION REQUIRED'
        text: |
          @everyone
          **üö® CRITICAL SYSTEM ALERT üö®**
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **üîç Details:**
          ‚Ä¢ Status: {{ .Status }}
          ‚Ä¢ Instance: {{ .Labels.instance }}
          ‚Ä¢ Category: {{ .Labels.category }}
          ‚Ä¢ Started: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          **‚ö° Action Required:** Immediate investigation needed!
          
          ---
          {{ end }}

  - name: 'discord-warnings'
    webhook_configs:
      - url: 'YOUR_DISCORD_WEBHOOK_URL_HERE'
        send_resolved: true
        title: '‚ö†Ô∏è Warning Alert'
        text: |
          **‚ö†Ô∏è System Warning**
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **Details:**
          ‚Ä¢ Instance: {{ .Labels.instance }}
          ‚Ä¢ Category: {{ .Labels.category }}
          ‚Ä¢ Time: {{ .StartsAt.Format "15:04:05" }}
          
          ---
          {{ end }}

  - name: 'discord-infrastructure'
    webhook_configs:
      - url: 'YOUR_DISCORD_WEBHOOK_URL_HERE'
        send_resolved: true
        title: 'üèóÔ∏è Infrastructure Alert'
        text: |
          **üèóÔ∏è Infrastructure Status Change**
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **System Impact:** {{ .Labels.impact }}
          **Instance:** {{ .Labels.instance }}
          
          ---
          {{ end }}

# Inhibition rules - prevent alert spam
inhibit_rules:
  # If a service is down, don't alert about resource usage
  - source_matchers:
      - severity="critical"
      - category="infrastructure"
    target_matchers:
      - category="resources"
    equal: ['instance']

  # If CPU is critical, don't alert about high CPU warnings
  - source_matchers:
      - alertname="CriticalCPUUsage"
    target_matchers:
      - alertname="HighCPUUsage"
    equal: ['instance']

  # If memory is critical, don't alert about high memory warnings  
  - source_matchers:
      - alertname="CriticalMemoryUsage"
    target_matchers:
      - alertname="HighMemoryUsage"
    equal: ['instance']