# /opt/monitoring/alertmanager/alertmanager.yml
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'discord-general'
  
  routes:
    # VPN ALERTS - First priority
    - matchers:
        - vm_type="vpn"
        - severity="critical"
      receiver: 'discord-vpn-critical'
      group_wait: 5s
      repeat_interval: 15m
      continue: false

    - matchers:
        - vm_type="vpn"
        - severity="warning"
      receiver: 'discord-vpn-warning'
      group_wait: 30s
      repeat_interval: 1h
      continue: false

    # GENERAL ALERTS
    - matchers:
        - severity="critical"
      receiver: 'discord-critical'
      group_wait: 5s
      repeat_interval: 30m
      continue: false

    - matchers:
        - severity="warning"
      receiver: 'discord-warning'
      group_wait: 30s
      repeat_interval: 2h
      continue: false

    # PERIODIC REPORTS
    - matchers:
        - category="report"
      receiver: 'discord-reports'
      group_wait: 5s
      repeat_interval: 1h
      continue: false

receivers:
  # VPN-SPECIFIC RECEIVERS
  - name: 'discord-vpn-critical'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        text: |
          üö® **VPN CRITICAL ALERT** üö®
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **Instance:** {{ .Labels.instance }}
          **Started:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          ---
          {{ end }}

  - name: 'discord-vpn-warning'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        text: |
          ‚ö†Ô∏è **VPN Warning** 
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **Instance:** {{ .Labels.instance }}
          **Time:** {{ .StartsAt.Format "15:04:05" }}
          
          ---
          {{ end }}

  # GENERAL RECEIVERS
  - name: 'discord-general'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        text: |
          üìä **Monitoring Alert**
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **Instance:** {{ .Labels.instance }}
          **Status:** {{ .Status }}
          
          ---
          {{ end }}

  - name: 'discord-critical'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        text: |
          üö® **CRITICAL ALERT** üö®
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **Instance:** {{ .Labels.instance }}
          **Started:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          
          ---
          {{ end }}

  - name: 'discord-warning'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        text: |
          ‚ö†Ô∏è **Warning Alert**
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          **Instance:** {{ .Labels.instance }}
          **Time:** {{ .StartsAt.Format "15:04:05" }}
          
          ---
          {{ end }}

  - name: 'discord-reports'
    webhook_configs:
      - url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: false
        text: |
          üìä **Health Report**
          
          {{ range .Alerts }}
          {{ .Annotations.description }}
          
          ---
          {{ end }}

# INHIBIT RULES
inhibit_rules:
  # If VPN VM is down, disable all other VPN VM alerts
  - source_matchers:
      - alertname="VPNNodeDown"
    target_matchers:
      - vm_type="vpn"
    equal: ['instance']

  # If there is a critical alert, disable warning alerts on the same instance
  - source_matchers:
      - severity="critical"
    target_matchers:
      - severity="warning"
    equal: ['instance']