# Global configuration
global:
  # SMTP settings (not used for Discord)
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alertmanager@localhost'

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route configuration
route:
  # Group alerts by these labels
  group_by: ['alertname', 'cluster', 'service']
  
  # Wait time before sending first notification for a group
  group_wait: 10s
  
  # Wait time before sending notification about new alerts added to group
  group_interval: 10s
  
  # Wait time before resending notification
  repeat_interval: 1h
  
  # Default receiver
  receiver: 'discord-general'
  
  # Sub-routes for different alert types
  routes:
    # Critical alerts - immediate notification
    - matchers:
        - severity="critical"
      receiver: 'discord-critical'
      group_wait: 5s
      repeat_interval: 15m
    
    # Warning alerts - batched notification  
    - matchers:
        - severity="warning"
      receiver: 'discord-warnings'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 1h
      
    # Infrastructure alerts - special handling
    - matchers:
        - service="infrastructure"
      receiver: 'discord-infrastructure'
      group_wait: 5s
      repeat_interval: 10m
      
    # VPN alerts - special handling
    - matchers:
        - service="vpn"
      receiver: 'discord-vpn'
      group_wait: 5s
      repeat_interval: 15m

# Receivers configuration
receivers:
  # General alerts receiver
  - name: 'discord-general'
    discord_configs:
        - webhook_url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
          send_resolved: true
        title: |
          {{ if eq .Status "firing" }}üîî **ALERT TRIGGERED**{{ else }}‚úÖ **ALERT RESOLVED**{{ end }}
        message: |
          {{ if eq .Status "firing" }}
          **üìä MONITORING ALERT**
          
          **üî¢ Alert Count:** {{ len .Alerts }} alert(s)
          **‚è∞ Time:** {{ (.Alerts | first).StartsAt.Format "2006-01-02 15:04:05" }}
          
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          
          ---
          {{ end }}
          {{ else }}
          **‚úÖ ALERT RESOLVED**
          
          **üî¢ Resolved:** {{ len .Alerts }} alert(s)
          **‚è∞ Resolved At:** {{ (.Alerts | first).EndsAt.Format "2006-01-02 15:04:05" }}
          
          {{ range .Alerts }}
          **‚úÖ {{ .Annotations.summary }}**
          {{ end }}
          {{ end }}

  # Critical alerts receiver
  - name: 'discord-critical'
    discord_configs:
      - webhook_url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        title: |
          {{ if eq .Status "firing" }}üö® **CRITICAL ALERT**{{ else }}‚úÖ **CRITICAL RESOLVED**{{ end }}
        message: |
          {{ if eq .Status "firing" }}
          @everyone
          
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          
          {{ .Annotations.description }}
          
          **üîó Runbook:** <https://your-runbook-url.com|Emergency Procedures>
          **üìû Escalation:** Contact on-call engineer immediately
          
          ---
          {{ end }}
          {{ else }}
          **‚úÖ CRITICAL ISSUE RESOLVED**
          
          **‚è∞ Resolved At:** {{ (.Alerts | first).EndsAt.Format "2006-01-02 15:04:05" }}
          **‚åõ Duration:** {{ (.Alerts | first).EndsAt.Sub (.Alerts | first).StartsAt }}
          
          {{ range .Alerts }}
          **‚úÖ {{ .Annotations.summary }}**
          
          System is back to normal operation.
          {{ end }}
          {{ end }}

  # Warning alerts receiver  
  - name: 'discord-warnings'
    discord_configs:
      - webhook_url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        title: |
          {{ if eq .Status "firing" }}‚ö†Ô∏è **WARNING ALERT**{{ else }}‚úÖ **WARNING RESOLVED**{{ end }}
        message: |
          {{ if eq .Status "firing" }}
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          
          {{ .Annotations.description }}
          
          ---
          {{ end }}
          {{ else }}
          **‚úÖ WARNING RESOLVED**
          
          **‚è∞ Resolved At:** {{ (.Alerts | first).EndsAt.Format "2006-01-02 15:04:05" }}
          
          {{ range .Alerts }}
          **‚úÖ {{ .Annotations.summary }}**
          {{ end }}
          {{ end }}

  # Infrastructure alerts receiver
  - name: 'discord-infrastructure'
    discord_configs:
      - webhook_url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        title: |
          {{ if eq .Status "firing" }}üèóÔ∏è **INFRASTRUCTURE ALERT**{{ else }}‚úÖ **INFRASTRUCTURE RESOLVED**{{ end }}
        message: |
          {{ if eq .Status "firing" }}
          @here
          
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          
          {{ .Annotations.description }}
          
          **üîß Infrastructure Team:** Please investigate immediately
          **üìà Dashboard:** <https://grafana.yourdomain.com|View Metrics>
          
          ---
          {{ end }}
          {{ else }}
          **‚úÖ INFRASTRUCTURE RESTORED**
          
          **‚è∞ Resolved At:** {{ (.Alerts | first).EndsAt.Format "2006-01-02 15:04:05" }}
          **‚åõ Downtime:** {{ (.Alerts | first).EndsAt.Sub (.Alerts | first).StartsAt }}
          
          {{ range .Alerts }}
          **‚úÖ {{ .Annotations.summary }}**
          {{ end }}
          {{ end }}

  # VPN alerts receiver
  - name: 'discord-vpn'
    discord_configs:
      - webhook_url: 'https://discord.com/api/webhooks/1378816244697796648/FlpeNbvNXObplrYfpAx_-AqznA8xDbdxUuqMrbWJ2EVqoLVs4CULGqUq4VKqaO2kGob0'
        send_resolved: true
        title: |
          {{ if eq .Status "firing" }}üåê **VPN ALERT**{{ else }}‚úÖ **VPN RESTORED**{{ end }}
        message: |
          {{ if eq .Status "firing" }}
          @here
          
          {{ range .Alerts }}
          {{ .Annotations.summary }}
          
          {{ .Annotations.description }}
          
          **üåê VPN Impact:** Remote access may be affected
          **üë• Users Affected:** All remote workers
          **üîß Network Team:** Please check VPN infrastructure
          
          ---
          {{ end }}
          {{ else }}
          **‚úÖ VPN SERVICE RESTORED**
          
          **‚è∞ Restored At:** {{ (.Alerts | first).EndsAt.Format "2006-01-02 15:04:05" }}
          **‚åõ Outage Duration:** {{ (.Alerts | first).EndsAt.Sub (.Alerts | first).StartsAt }}
          
          {{ range .Alerts }}
          **‚úÖ {{ .Annotations.summary }}**
          
          **üì¢ Announcement:** VPN service is fully operational. All users can reconnect.
          {{ end }}
          {{ end }}

# Inhibit rules - Prevent spam
inhibit_rules:
  # Inhibit warning if critical alert is firing for same instance
  - source_matchers:
      - severity="critical"
    target_matchers:
      - severity="warning"
    equal: ['alertname', 'instance']
    
  # Inhibit duplicate alerts
  - source_matchers:
      - alertname="InstanceDown"
    target_matchers:
      - alertname=~"High.*Usage"
    equal: ['instance']