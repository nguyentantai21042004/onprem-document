# /opt/monitoring/prometheus/health_report_rules.yml
groups:
  # =============================================================================
  # HEALTH REPORT RECORDING RULES - Calculate health metrics
  # =============================================================================
  - name: health_metrics.rules
    interval: 60s
    rules:
      # Calculate overall system health score (0-100)
      - record: system:health_score
        expr: |
          (
            (100 - (100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100))) * 0.3 +
            ((node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100) * 0.3 +
            ((node_filesystem_free_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100) * 0.2 +
            (up * 100) * 0.2
          )
        labels:
          report_type: "health_score"

      # VM uptime in hours
      - record: system:uptime_hours
        expr: (time() - node_boot_time_seconds) / 3600
        labels:
          report_type: "uptime"

      # Network throughput summary
      - record: system:network_throughput_mbps
        expr: |
          (
            rate(node_network_receive_bytes_total{device!="lo"}[5m]) + 
            rate(node_network_transmit_bytes_total{device!="lo"}[5m])
          ) / 1024 / 1024 * 8
        labels:
          report_type: "network"

  # =============================================================================
  # PERIODIC HEALTH REPORTS - Generate hourly reports
  # =============================================================================
  - name: periodic_reports.rules
    interval: 300s # Every 5 minutes
    rules:
      # Hourly health report trigger
      - alert: HourlyHealthReport
        expr: |
          (
            minute() >= 0 and minute() <= 4
          ) and (
            system:health_score > -1
          )
        for: 0s
        labels:
          severity: info
          category: report
          impact: none
          report_interval: hourly
        annotations:
          summary: "ğŸ“Š Hourly VM Health Report"
          description: |
            **ğŸ–¥ï¸ VM HEALTH REPORT - {{ $labels.instance }}**
            
            **â° Report Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
            
            **ğŸ“ˆ System Metrics:**
            â€¢ **Health Score:** {{ query "system:health_score{instance='$labels.instance'}" | first | value | printf "%.1f" }}%
            â€¢ **Uptime:** {{ query "system:uptime_hours{instance='$labels.instance'}" | first | value | printf "%.1f" }} hours
            â€¢ **CPU Usage:** {{ query "100 - (avg by(instance) (irate(node_cpu_seconds_total{mode='idle',instance='$labels.instance'}[5m])) * 100)" | first | value | printf "%.1f" }}%
            â€¢ **Memory Usage:** {{ query "(node_memory_MemTotal_bytes{instance='$labels.instance'} - node_memory_MemAvailable_bytes{instance='$labels.instance'}) / node_memory_MemTotal_bytes{instance='$labels.instance'} * 100" | first | value | printf "%.1f" }}%
            â€¢ **Disk Usage:** {{ query "(node_filesystem_size_bytes{mountpoint='/',instance='$labels.instance'} - node_filesystem_free_bytes{mountpoint='/',instance='$labels.instance'}) / node_filesystem_size_bytes{mountpoint='/',instance='$labels.instance'} * 100" | first | value | printf "%.1f" }}%
            
            **ğŸŒ Network:**
            â€¢ **Throughput:** {{ query "system:network_throughput_mbps{instance='$labels.instance'}" | first | value | printf "%.2f" }} Mbps
            
            **ğŸ’¾ Storage:**
            â€¢ **Free Space:** {{ query "node_filesystem_free_bytes{mountpoint='/',instance='$labels.instance'}" | first | value | humanizeBytes }}
            â€¢ **Total Space:** {{ query "node_filesystem_size_bytes{mountpoint='/',instance='$labels.instance'}" | first | value | humanizeBytes }}

      # Daily summary report (at 9 AM)
      - alert: DailySummaryReport
        expr: |
          (
            hour() == 9 and minute() >= 0 and minute() <= 4
          ) and (
            system:health_score > -1
          )
        for: 0s
        labels:
          severity: info
          category: report
          impact: none
          report_interval: daily
        annotations:
          summary: "ğŸ“‹ Daily VM Summary Report"
          description: |
            **ğŸ“‹ DAILY SUMMARY - {{ $labels.instance }}**
            
            **ğŸ“… Date:** {{ .StartsAt.Format "2006-01-02" }}
            
            **ğŸ“Š 24h Averages:**
            â€¢ **Avg Health Score:** {{ query "avg_over_time(system:health_score{instance='$labels.instance'}[24h])" | first | value | printf "%.1f" }}%
            â€¢ **Avg CPU Usage:** {{ query "avg_over_time((100 - (avg by(instance) (irate(node_cpu_seconds_total{mode='idle',instance='$labels.instance'}[5m])) * 100))[24h:5m])" | first | value | printf "%.1f" }}%
            â€¢ **Current Uptime:** {{ query "system:uptime_hours{instance='$labels.instance'}" | first | value | printf "%.1f" }} hours
            
            **ğŸ”„ System Status:** {{ if query "up{instance='$labels.instance'}" | first | value }}âœ… Online{{ else }}âŒ Offline{{ end }}
            
            **ğŸ“ˆ Trend:** Last 24h performance summary 